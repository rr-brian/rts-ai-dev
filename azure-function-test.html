<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Function Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        button {
            padding: 10px 15px;
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #106ebe;
        }
        textarea {
            width: 100%;
            height: 150px;
            margin-top: 10px;
            font-family: monospace;
        }
        .log-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Azure Function Test</h1>
    
    <div>
        <h2>Function Configuration</h2>
        <div>
            <label for="functionUrl">Function URL:</label>
            <input type="text" id="functionUrl" style="width: 100%;" value="https://fn-conversationsave.azurewebsites.net/api/conversations/update">
        </div>
        <div style="margin-top: 10px;">
            <label for="functionKey">Function Key:</label>
            <input type="text" id="functionKey" style="width: 100%;" value="XlFZ1cQXygnRSo9JZHz3Ki9_SlO_cbQ7m7sIRURNE8DuAzFuCFpIFQ==">
        </div>
    </div>

    <div style="margin-top: 20px;">
        <h2>Request Payload</h2>
        <textarea id="requestPayload">{
  "conversationId": "00000000-0000-0000-0000-000000000000",
  "userId": "test-user-id",
  "messages": [
    {
      "role": "user",
      "content": "Hello"
    },
    {
      "role": "assistant",
      "content": "Hi there! How can I help you today?"
    }
  ]
}</textarea>
    </div>

    <div>
        <button id="sendRequest">Send Request</button>
        <button id="clearLogs">Clear Logs</button>
    </div>

    <div>
        <h2>Logs</h2>
        <div class="log-container" id="logContainer"></div>
    </div>

    <script>
        // Function to log messages
        function log(message, isError = false) {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.style.color = isError ? 'red' : 'black';
            logEntry.style.marginBottom = '5px';
            
            // Format objects nicely
            if (typeof message === 'object') {
                try {
                    message = JSON.stringify(message, null, 2);
                } catch (e) {
                    message = message.toString();
                }
            }
            
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Send request to Azure Function
        document.getElementById('sendRequest').addEventListener('click', async () => {
            const functionUrl = document.getElementById('functionUrl').value;
            const functionKey = document.getElementById('functionKey').value;
            const requestPayload = document.getElementById('requestPayload').value;
            
            log('Sending request to Azure Function...');
            log(`URL: ${functionUrl}`);
            log('Function key: ' + (functionKey ? 'Key exists (not showing for security)' : 'Key is missing'));
            
            try {
                // Parse the payload to validate it's proper JSON
                const payload = JSON.parse(requestPayload);
                log('Request payload:', false);
                log(payload, false);
                
                // Send the request
                log('Sending fetch request...');
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-functions-key': functionKey
                    },
                    body: requestPayload
                });
                
                log(`Response status: ${response.status} ${response.statusText}`);
                
                // Get response headers
                const headers = {};
                response.headers.forEach((value, key) => {
                    headers[key] = value;
                });
                log('Response headers:', false);
                log(headers, false);
                
                // Get response body
                const responseText = await response.text();
                try {
                    // Try to parse as JSON
                    const responseJson = JSON.parse(responseText);
                    log('Response body (JSON):', false);
                    log(responseJson, false);
                } catch (e) {
                    // If not JSON, show as text
                    log('Response body (text):', false);
                    log(responseText, false);
                }
                
            } catch (error) {
                log(`Error: ${error.message}`, true);
                log('Error details:', true);
                log({
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                }, true);
            }
        });
        
        // Clear logs
        document.getElementById('clearLogs').addEventListener('click', () => {
            document.getElementById('logContainer').innerHTML = '';
            log('Logs cleared');
        });
        
        // Initial log
        log('Azure Function Test page loaded');
    </script>
</body>
</html>
